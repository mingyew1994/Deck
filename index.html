<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deck Box — Tap to Manage (Firebase)</title>
  <style>
    :root { --bg:#0b0f14; --card:#121922; --text:#ecf2f8; --muted:#9fb3c8; --accent:#57b2ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg,#0b0f14,#0b0f14 60%,#0e141b); color:var(--text); }
    .wrap { max-width: 920px; margin: 0 auto; padding: 20px; }
    .card { background: var(--card); border:1px solid #1d2633; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { font-size: 1.6rem; margin: 0 0 4px; letter-spacing:.2px; }
    .sub { color: var(--muted); margin-bottom: 14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    input, textarea, button, select {
      background:#0c1219; color:var(--text); border:1px solid #1d2633; border-radius:12px; padding:12px 14px; font-size:15px;
    }
    input, select, button { height:44px; }
    input::placeholder { color:#5f748a; }
    button { cursor:pointer; font-weight:600; }
    .btn { background:#101925; }
    .btn:hover { background:#132033; }
    .btn.primary { background:var(--accent); color:#00121f; border-color:transparent; }
    .btn.primary:hover { filter:brightness(1.05); }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width:840px){ .grid { grid-template-columns: 3fr 2fr; } }
    ul { list-style:none; padding:0; margin:0; }
    li { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px solid #1d2633; border-radius:12px; background:#0d141c; margin-bottom:8px; }
    .pill { font:600 12px/1.6 system-ui; padding:4px 8px; border-radius:999px; background:#0c1924; border:1px solid #223246; color:#9cc9f5; }
    .muted { color:var(--muted); font-size:13px; }
    .spacer { height:6px; }
    .footer { text-align:center; color:#6a7f93; font-size:12px; margin-top:14px; }
    .hidden { display:none; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Deck Box</h1>
    <div class="sub">Deck: <span id="deckSlug" class="pill">loading…</span></div>

    <div id="noDeck" class="card" style="margin-bottom:12px;">
      <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <strong>No deck loaded.</strong>
          <div class="muted">Create a new deck (generates a secret link), or paste an existing deck ID.</div>
        </div>
        <div class="row">
          <button id="createBtn" class="btn primary">Create new deck</button>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <input id="existingId" placeholder="Paste existing deck UUID (xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)" style="flex:1; min-width:260px;" />
        <button id="openExistingBtn" class="btn">Open</button>
      </div>
    </div>

    <div class="grid" id="app" class="hidden">
      <div class="stack">
        <div class="row">
          <input id="cardId" placeholder="Card ID (e.g., sv4-123)" style="flex:2; min-width:180px" />
          <input id="cardName" placeholder="Name (optional)" style="flex:3; min-width:200px" />
        </div>
        <div class="row">
          <button id="addBtn" class="btn primary">Add to deck</button>
          <button id="removeBtn" class="btn">Remove from deck</button>
          <button id="checkBtn" class="btn">Check in deck?</button>
        </div>

        <div class="card">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <strong>Cards in Deck</strong>
            <span class="muted" id="countLabel">0 cards</span>
          </div>
          <div class="spacer"></div>
          <ul id="list"></ul>
        </div>
      </div>

      <div class="stack">
        <div class="card">
          <strong>Deck Link</strong>
          <div class="spacer"></div>
          <div class="row">
            <input id="deckUrl" readonly style="flex:1" />
            <button id="copyUrlBtn" class="btn">Copy URL</button>
          </div>
          <div class="spacer"></div>
          <div class="muted">Write this URL to your NFC tag. Anyone with this link can view and edit this deck.</div>
        </div>

        <div class="card">
          <strong>Import / Export</strong>
          <div class="spacer"></div>
          <div class="row">
            <button id="exportBtn" class="btn">Export JSON</button>
            <button id="copyBtn" class="btn">Copy</button>
            <button id="downloadBtn" class="btn">Download</button>
          </div>
          <div class="spacer"></div>
          <textarea id="jsonArea" rows="8" placeholder='Paste JSON here to import'></textarea>
          <div class="spacer"></div>
          <div class="row">
            <button id="importBtn" class="btn">Import JSON</button>
            <button id="clearBtn" class="btn">Clear deck</button>
          </div>
        </div>

        <div class="card">
          <strong>Notes</strong>
          <div class="spacer"></div>
          <ul class="muted">
            <li>Use Pokémon card IDs like <code>sv4-123</code>. Name is optional.</li>
            <li>Anyone with this URL can edit (no login). Use unique, unguessable UUIDs.</li>
            <li>Write the URL onto your NFC tag with any NFC writer app.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="footer">v1.0 — Firebase Firestore, real-time sync, no login.</div>
  </div>
</div>

<!-- Firebase (Modular SDK) -->
<script type="module">
  // ====== Firebase SDK imports ======
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // ====== Your Firebase config ======
  const firebaseConfig = {
    apiKey: "AIzaSyCxmKPfglneWP0PbzFumT9Az24M9k4ZuJI",
    authDomain: "decksmiths-2025.firebaseapp.com",
    projectId: "decksmiths-2025",
    storageBucket: "decksmiths-2025.firebasestorage.app",
    messagingSenderId: "487112789478",
    appId: "1:487112789478:web:5b8be16aea20c90a199a27",
    measurementId: "G-GFBVJ4BGDT"
  };

  // ====== App init ======
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  try { enableIndexedDbPersistence(db); } catch (_) {}

  // ====== DOM helpers ======
  const $ = sel => document.querySelector(sel);
  const byId = id => document.getElementById(id);
  const slugSpan = byId('deckSlug');
  const deckUrlInput = byId('deckUrl');

  // ====== Routing / Slug ======
  const params = new URLSearchParams(location.search);
  let slug = (params.get('deck')||'').trim();

  function setSlug(newSlug, push=true){
    slug = newSlug;
    slugSpan.textContent = slug || '—';
    if (slug) {
      const url = `${location.origin}${location.pathname}?deck=${encodeURIComponent(slug)}`;
      deckUrlInput.value = url;
      if (push) history.replaceState(null, '', url);
      $('#noDeck').classList.add('hidden');
      $('#app').classList.remove('hidden');
    } else {
      $('#noDeck').classList.remove('hidden');
      $('#app').classList.add('hidden');
    }
  }

  setSlug(slug, false);

  // ====== Firestore helpers ======
  const deckRef = () => doc(db, 'decks', slug);
  let unsub = null;          // snapshot unsubscribe
  let currentDeck = null;    // last snapshot state

  async function ensureDeckExists(){
    if (!slug) return;
    const snap = await getDoc(deckRef());
    if (!snap.exists()) {
      await setDoc(deckRef(), { cards: [], updated_at: serverTimestamp() });
    }
  }

  async function subscribe(){
    if (!slug) return;
    if (unsub) { unsub(); unsub=null; }
    await ensureDeckExists();
    unsub = onSnapshot(deckRef(), (snap)=>{
      if (snap.exists()) {
        currentDeck = snap.data();
        render();
      }
    });
  }

  function normalizeId(s){ return (s||'').trim().toLowerCase(); }
  function fmtCount(n){ return `${n} card${n===1?'':'s'}`; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  // ====== UI Render ======
  function render(){
    const list = byId('list');
    list.innerHTML = '';
    const cards = (currentDeck?.cards)||[];
    byId('countLabel').textContent = fmtCount(cards.length);
    cards.forEach(c=>{
      const li = document.createElement('li');
      const left = document.createElement('div');
      left.innerHTML = `<div><strong>${c.id}</strong>${c.name?` — ${escapeHtml(c.name)}`:''}</div>
                        <div class="muted">Added ${new Date(c.added_at||Date.now()).toLocaleString()}</div>`;
      const right = document.createElement('div');
      const del = document.createElement('button');
      del.textContent = 'Remove';
      del.className = 'btn';
      del.onclick = ()=> removeCard(c.id);
      right.appendChild(del);
      li.appendChild(left);
      li.appendChild(right);
      list.appendChild(li);
    });
  }

  // ====== Actions ======
  async function addCard(id, name){
    id = normalizeId(id);
    if(!id){ alert('Please enter a Card ID (e.g., sv4-123).'); return; }
    const cards = (currentDeck?.cards)||[];
    if (cards.some(c=>c.id===id)) { alert('That ID is already in this deck.'); return; }
    const next = [...cards, { id, name:(name||'').trim(), added_at: new Date().toISOString() }];
    await updateDoc(deckRef(), { cards: next, updated_at: serverTimestamp() });
    byId('cardId').value=''; byId('cardName').value='';
  }

  async function removeCard(id){
    id = normalizeId(id || byId('cardId').value);
    const cards = (currentDeck?.cards)||[];
    const next = cards.filter(c=>c.id!==id);
    await updateDoc(deckRef(), { cards: next, updated_at: serverTimestamp() });
  }

  async function checkCard(id){
    id = normalizeId(id || byId('cardId').value);
    if(!id){ alert('Enter an ID to check.'); return; }
    const has = ((currentDeck?.cards)||[]).some(c=>c.id===id);
    alert(has ? `✅ Yes, ${id} is in this deck.` : `❌ No, ${id} is not in this deck.`);
  }

  function exportJson(){
    const data = { deck: slug, cards: (currentDeck?.cards)||[], updated_at: currentDeck?.updated_at || null };
    return JSON.stringify(data, null, 2);
  }

  function download(filename, text){
    const a = document.createElement('a');
    a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(text);
    a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  }

  // ====== Wire up ======
  byId('createBtn').onclick = async ()=>{
    const id = crypto.randomUUID();
    setSlug(id);
    await setDoc(deckRef(), { cards: [], updated_at: serverTimestamp() });
    await subscribe();
  };

  byId('openExistingBtn').onclick = ()=>{
    const id = byId('existingId').value.trim();
    if (!id) return alert('Paste a deck UUID first.');
    setSlug(id);
    subscribe();
  };

  byId('addBtn').onclick = () => addCard(byId('cardId').value, byId('cardName').value);
  byId('removeBtn').onclick = () => removeCard(byId('cardId').value);
  byId('checkBtn').onclick = () => checkCard(byId('cardId').value);

  byId('exportBtn').onclick = () => { byId('jsonArea').value = exportJson(); };
  byId('copyBtn').onclick = async () => { const t = exportJson(); byId('jsonArea').value=t; try{ await navigator.clipboard.writeText(t); alert('Copied!'); }catch{} };
  byId('downloadBtn').onclick = () => download(`deck-${slug}.json`, exportJson());

  byId('importBtn').onclick = async () => {
    try{
      const data = JSON.parse(byId('jsonArea').value);
      if(!data.cards || !Array.isArray(data.cards)) throw new Error('Invalid JSON: missing "cards" array.');
      await updateDoc(deckRef(), { cards: data.cards.map(c=>({ id: normalizeId(c.id), name:(c.name||'').trim(), added_at: c.added_at || new Date().toISOString() })), updated_at: serverTimestamp() });
      alert('Imported!');
    }catch(e){ alert('Import failed: ' + e.message); }
  };

  byId('clearBtn').onclick = async () => {
    if(confirm('Clear all cards in this deck?')){
      await updateDoc(deckRef(), { cards: [], updated_at: serverTimestamp() });
    }
  };

  byId('copyUrlBtn').onclick = async () => {
    try { await navigator.clipboard.writeText(deckUrlInput.value); alert('Deck URL copied!'); } catch { /* ignore */ }
  };

  // ====== Start if slug present ======
  if (slug) { subscribe(); }
</script>
</body>
</html>
